<!-- file: care-questions-home-fixed.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Care Questions ‚Äî Home</title>
<style>
  :root{
    --bg:#f6f9fc; --card:#ffffff; --ink:#0f172a; --muted:#475569;
    --ring:rgba(59,130,246,.35); --shadow:0 10px 25px rgba(2,8,23,.12), 0 2px 6px rgba(2,8,23,.08);
    --radius:20px; --brand:#1f5f86; --chipbg:#e8f3ff; --primary:#3b82f6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; font-family: Arial, ui-sans-serif, system-ui, -apple-system, "Helvetica Neue";
        font-size:17px; color:var(--ink); background:var(--bg); }
  .container{max-width:1200px;margin:20px auto;padding:0 16px}
  .header{display:flex;gap:16px;justify-content:flex-end;align-items:center;margin-bottom:8px}
  .top-button{
    background:linear-gradient(180deg,#e8f0ff,#d5e6ff); color:#0b2a5d;text-decoration:none;
    padding:14px 22px;border-radius:14px;border:2px solid #a3c2ff;font-weight:700; box-shadow:var(--shadow);
  }
  .top-button:focus-visible{outline:3px solid var(--ring);outline-offset:3px}

  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:22px}
  .card{
    background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);
    display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;
    padding:12px;min-height:220px;border:1px solid #e5e7eb;
  }
  .card-start{background:#dff0fa;border:2px solid #b6e0fb;cursor:pointer;position:relative;overflow:hidden}
  .card-start::before{ content:"";position:absolute;inset:0;background:url("https://ilonafridman.github.io/Starthere.jpg") center/cover no-repeat;opacity:.25; }
  .start-title{font-size:40px;font-weight:800;color:#17324a;position:relative}

  @media (max-width: 900px){ .grid{ grid-template-columns:1fr 1fr } .card-start .start-title{font-size:34px}}
  @media (max-width: 640px){ .grid{ grid-template-columns:1fr } .header{justify-content:center}}

  /* Modal */
  .modal{ position:fixed; inset:0; display:none; }
  .modal[aria-hidden="false"]{ display:block; }
  .modal-backdrop{ position:absolute; inset:0; background:rgba(15,23,42,.45); backdrop-filter: blur(4px); }
  .modal-card{
    position:relative; max-width:960px; margin:6vh auto; background:var(--card); border-radius:22px;
    box-shadow:var(--shadow); padding:24px 22px 16px; border:1px solid #e5e7eb;
  }
  .icon-btn.close{ position:absolute; right:10px; top:10px; background:#efefef; border:none;border-radius:999px; width:36px; height:36px; cursor:pointer; }
  .modal-header{ position:relative; padding-right:160px; }
  .modal-header h2{ margin:4px 0 8px; font-size:28px }
  .lede{ color:var(--muted); margin:0 0 14px; font-size:16px }
  /* ‚ÄúYour Care Team‚Äù button inside modal header */
  .header-inline-btn{
    position:absolute; top:0; right:0; transform:translateY(-6px);
    background:linear-gradient(180deg,#e8f0ff,#d5e6ff); color:#0b2a5d;
    padding:10px 16px; border-radius:12px; border:2px solid #a3c2ff; font-weight:800; text-decoration:none;
  }

  .accordion{ display:flex; flex-direction:column; gap:12px; position:relative; }
  .section{ border:1px solid #d9e3f5; border-radius:16px; background:#f7fbff; overflow:hidden; }
  .section summary{
    list-style:none; cursor:pointer; padding:12px 16px; font-weight:800; color:#0c2f66;
    background:#edf4ff; border-bottom:1px solid #d9e3f5; outline:none; display:flex; align-items:center; gap:8px;
  }
  .section summary::before{ content:"‚ñ∂"; font-weight:900; width:1em; display:inline-block; transform:translateY(-1px); }
  .section[open] summary{ background:#dce9ff }
  .section[open] summary::before{ content:"‚ñº"; }
  .section-content{ max-height:50vh; overflow:auto; padding:8px; }
  .section-toolbar{ display:flex; gap:8px; padding:6px 6px 8px 6px; align-items:center; flex-wrap:wrap }
  .mini{ border:1px solid #cbd5e1; background:#fff; border-radius:10px; padding:6px 10px; font-weight:700; cursor:pointer; }
  .eres-btn{ margin-left:auto; border:1px solid #94a3b8; background:#fff; border-radius:12px; padding:8px 14px; font-weight:800; text-decoration:none; color:#0b2a5d; display:inline-flex; align-items:center; line-height:1; }
  .eres-btn:hover{ background:#f1f5f9 }

  .q-list{ list-style:none; padding:0; margin:0; }
  .q-list li{ display:flex; gap:10px; padding:10px 8px; border-bottom:1px solid #eaeef5; line-height:1.35 }
  .q-list li:last-child{ border-bottom:none }

  .modal-footer{ display:flex; gap:12px; justify-content:space-between; align-items:center; margin-top:12px; flex-wrap:wrap; }
  .primary{ background:linear-gradient(180deg,#60a5fa,#3b82f6); color:white; border:none; border-radius:12px; padding:12px 18px; font-weight:800; cursor:pointer; }
  .primary[disabled]{opacity:.5; cursor:not-allowed}
  .secondary{ border:1px solid #cbd5e1; border-radius:12px; padding:10px 14px; text-decoration:none; color:#0b2a5d; font-weight:700; background:#f8fafc; }
  .links-pack{ display:flex; flex-wrap:wrap; gap:8px }
  :where(button,a,input,summary):focus-visible{ outline:3px solid var(--ring); outline-offset:2px }

  /* Accordion scroll area + vertical slider */
  #accordion{ max-height:56vh; overflow:auto; }
  .vslider-wrap{
    position:absolute; top:80px; bottom:86px; right:6px; width:28px;
    display:none; align-items:center; justify-content:center; pointer-events:none;
  }
  .vslider-wrap.visible{ display:flex; }
  .vslider{
    pointer-events:auto; appearance:none; -webkit-appearance:none;
    writing-mode:bt-lr; width:140px; height:20px; transform:rotate(90deg);
    background:transparent; margin:0;
  }
  .vslider::-webkit-slider-runnable-track{ height:6px; border-radius:999px; background:#e2e8f0; }
  .vslider::-moz-range-track{ height:6px; border-radius:999px; background:#e2e8f0; }
  .vslider::-webkit-slider-thumb{
    -webkit-appearance:none; width:22px; height:22px; border-radius:999px; background:var(--primary); box-shadow:var(--shadow); margin-top:-8px;
  }
  .vslider::-moz-range-thumb{ width:22px; height:22px; border:none; border-radius:999px; background:var(--primary); }
  /* Dev-only link audit styles */
  .audit{margin-top:24px;background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
  .audit summary{font-weight:800;padding:12px 16px;cursor:pointer;background:#f3f6fb}
  .audit table{width:100%;border-collapse:collapse;font-size:14px}
  .audit th,.audit td{padding:10px;border-top:1px solid #eef2f7;vertical-align:top;word-break:break-all}
  .audit th{text-align:left;background:#fafcff}
  .audit code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
</style>
</head>
<body>
  <header class="container header">
    <a class="top-button" href="#care-team" data-open="modal-care-team" role="button" aria-haspopup="dialog">Your Care Team</a>
    <a class="top-button" href="#helpful-info" data-open="modal-helpful" role="button" aria-haspopup="dialog">Helpful Information</a>
  </header>

  <main class="container grid">
    <button class="card card-start" id="startHereBtn" aria-haspopup="dialog" aria-controls="startModal">
      <span class="start-title">Start Here</span>
    </button>

    <div class="card">
      <a class="thumb" href="https://ilonafridman.github.io/diagnosis/diagnosis.html" target="_blank" rel="noopener">
        <img src="https://ilonafridman.github.io/AfterDiagnosis.jpg" alt="After diagnosis image">
      </a>
      <div class="card-title">
        <a href="https://ilonafridman.github.io/diagnosis/diagnosis.html" target="_blank" rel="noopener">
          Questions to ask after being diagnosed
        </a>
      </div>
    </div>

    <div class="card">
      <a class="thumb" href="https://ilonafridman.github.io/choosingtreatment/choosingtreatment.html" target="_blank" rel="noopener">
        <img src="https://ilonafridman.github.io/ChoosingTreatment.jpg" alt="Choosing treatment image">
      </a>
      <div class="card-title">
        <a href="https://ilonafridman.github.io/choosingtreatment/choosingtreatment.html" target="_blank" rel="noopener">
          Questions to explore for choosing treatment
        </a>
      </div>
    </div>

    <div class="card">
      <a class="thumb" href="https://ilonafridman.github.io/treatment/treatment.html" target="_blank" rel="noopener">
        <img src="https://ilonafridman.github.io/DuringTreatment.jpg" alt="During treatment image">
      </a>
      <div class="card-title">
        <a href="https://ilonafridman.github.io/treatment/treatment.html" target="_blank" rel="noopener">
          Questions to ask during treatment
        </a>
      </div>
    </div>

    <div class="card">
      <a class="thumb" href="https://ilonafridman.github.io/afterdiagnosis/afterdiagnosis.html" target="_blank" rel="noopener">
        <img src="https://ilonafridman.github.io/AfterTreatment.JPG" alt="After treatment image">
      </a>
      <div class="card-title">
        <a href="https://ilonafridman.github.io/afterdiagnosis/afterdiagnosis.html" target="_blank" rel="noopener">
          Questions after Treatment
        </a>
      </div>
    </div>

    <div class="card">
      <a class="thumb" href="https://ilonafridman.github.io/complementary/complementary.html" target="_blank" rel="noopener">
        <img src="https://ilonafridman.github.io/Complementary Therapy.jpg" alt="Complementary therapy image">
      </a>
      <div class="card-title">
        <a href="https://ilonafridman.github.io/complementary/complementary.html" target="_blank" rel="noopener">
          Questions to ask about integrative therapy
        </a>
      </div>
    </div>
  </main>

  <!-- Dev-only: Link Audit (remove in prod) -->
  <section class="container audit">
    <details>
      <summary>üîé Link Audit (images & targets)</summary>
      <div id="auditTableWrap"></div>
    </details>
  </section>

  <!-- ===== Start Here Modal ===== -->
  <div class="modal" id="startModal" role="dialog" aria-modal="true" aria-labelledby="startModalTitle" aria-hidden="true">
    <div class="modal-backdrop" data-close="startModal"></div>
    <div class="modal-card" role="document">
      <button class="icon-btn close" aria-label="Close dialog" data-close="startModal">‚úï</button>

      <div class="modal-header" aria-describedby="startModalIntro">
        <h2 id="startModalTitle">Questions to ask your provider</h2>
        <a class="header-inline-btn" href="#care-team" data-open="modal-care-team" role="button" aria-haspopup="dialog">Your Care Team</a>
        <div id="startModalIntro" class="lede-panel">
          <p>Many patients wonder: What should I ask my provider? How could I move forward?</p>
          <p>Open one or more sections and check the questions you want to bring to your care team. You can Download, Print, or Email a PDF.</p>
        </div>
      </div>

      <div class="accordion" id="accordion"><!-- injected by JS --></div>
      <!-- vertical slider holder -->
      <div class="vslider-wrap" id="vsliderWrap" aria-hidden="true">
        <input type="range" id="vslider" class="vslider" min="0" max="100" value="0" step="1" aria-label="Scroll questions">
      </div>

      <div class="modal-footer">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="primary" id="downloadPdfBtn" disabled>Download PDF</button>
          <button class="primary" id="printPdfBtn" disabled>Print PDF</button>
          <button class="primary" id="emailPdfBtn" disabled>Email / Share PDF</button>
        </div>
        <div class="links-pack">
          <a class="secondary" href="https://ilonafridman.github.io/diagnosis/diagnosis.html" target="_blank" rel="noopener">After diagnosis</a>
          <a class="secondary" href="https://ilonafridman.github.io/choosingtreatment/choosingtreatment.html" target="_blank" rel="noopener">Choosing treatment</a>
          <a class="secondary" href="https://ilonafridman.github.io/treatment/treatment.html" target="_blank" rel="noopener">During treatment</a>
          <a class="secondary" href="https://ilonafridman.github.io/complementary/complementary.html" target="_blank" rel="noopener">Integrative therapy</a>
          <a class="secondary" href="https://ilonafridman.github.io/afterdiagnosis/afterdiagnosis.html" target="_blank" rel="noopener">After treatment</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Simple stub modals -->
  <div class="modal" id="modal-care-team" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-backdrop" data-close="modal-care-team"></div>
    <div class="modal-card">
      <button class="icon-btn close" aria-label="Close dialog" data-close="modal-care-team">‚úï</button>
      <h2>Your Care Team</h2>
      <p>List roles/contacts here.</p>
    </div>
  </div>

  <div class="modal" id="modal-helpful" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-backdrop" data-close="modal-helpful"></div>
    <div class="modal-card">
      <button class="icon-btn close" aria-label="Close dialog" data-close="modal-helpful">‚úï</button>
      <h2>Helpful Information</h2>
      <p>Portal, maps, transportation, financial counseling, support, etc.</p>
    </div>
  </div>

<!-- jsPDF (UMD) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* ---------- Data ---------- */
const TOPICS = {
  diagnosis: {
    title: "I would like to understand my diagnosis better",
    questions: [
      "What type and stage of breast cancer do I have?",
      "How fast is my cancer growing?",
      "Do I need any more tests or biopsies to be sure about my diagnosis?",
      "Do I need to do genetic testing?",
      "How much time do I have to decide on my treatment?",
      "Which doctors should I see, and when should I see them?",
    ]
  },
  choosing: {
    title: "I need to choose a treatment",
    questions: [
      "What treatment options do I have?",
      "Which treatment gives the lowest chance of the cancer coming back?",
      "If you were in my place, which treatment would you choose?",
      "What happens if I decide not to have surgery, radiation, or chemotherapy?",
      "How soon do I need to start treatment? Do I have time to get a second opinion?",
      "What are my surgery options?",
      "What problems or risks come with each type of surgery?",
      "What are the side effects of radiation?",
      "Will I need chemotherapy?",
      "Will I need hormone therapy?",
      "When should I decide about breast reconstruction surgery?"
    ]
  },
  during: {
    title: "I am going through treatment",
    questions: [
      "Can you walk me through the steps involved in my treatment plan?",
      "What side effects should I expect from my treatment?",
      "Are there any tools or tips you recommend for coping with common side effects?",
      "When should I contact my healthcare team between visits?",
      "What should I do if my personal situation makes it hard to get to treatment?",
      "Are there counselors or support groups available?",
      "What integrative therapy services are available to support me during treatment?",
      "The cost of my treatment is high ‚Äî what options do I have for financial assistance?"
    ]
  },
  integrative: {
    title: "I hope to learn about complementary and integrative therapy",
    questions: [
      "Can any vitamins, herbs, or lifestyle changes make my treatment less effective or cause side effects?",
      "How do I know if a supplement or therapy is safe for me?",
      "Where can I find good information about complementary/non-mainstream therapies for people with cancer?",
      "What should I eat or drink during treatment to help me stay strong and recover better?",
      "Where can I find a doctor or specialist who works in integrative medicine?"
    ]
  },
  after: {
    title: "I completed my treatment. What is next?",
    questions: [
      "Which specific tests or screenings will I need during follow-up, and how often?",
      "Who will coordinate my follow-up care among my healthcare providers?",
      "What symptoms should prompt me to contact you between scheduled visits?",
      "Am I at increased risk for any health conditions because of my treatment?",
      "Are there lifestyle changes or behaviors you recommend to help reduce the risk of cancer coming back?",
      "Can you recommend support groups or counseling services for breast cancer survivors?"
    ]
  }
};

const ER_LINKS = {
  diagnosis: "https://ilonafridman.github.io/diagnosis/diagnosisinfo.html",
  choosing: "https://ilonafridman.github.io/choosingtreatment/choosingtreatmentinfo.html",
  during:   "https://ilonafridman.github.io/treatment/treatmentinfo.html",
  after:    "https://ilonafridman.github.io/afterdiagnosis/afterdiagnosisinfo.html",
  integrative: "https://ilonafridman.github.io/complementary/complementaryinfo.html",
};

const RECOMMENDATIONS = [
  "<b>Consider bringing a friend or loved one</b> to help you remember information shared during your appointment.",
  "<b>Learn about your specific condition</b> from trusted sources of information.",
  "<b>Your healthcare team welcomes your questions.</b> Don‚Äôt hesitate to ask to clarify anything you're unsure about.",
  "<b>Your questions are important.</b> Sharing your questions at the beginning of the appointment will help address your concerns.",
  "<b>Stay connected between visits.</b> Use the patient portal, phone, or email to reach the team when questions arise.",
  "<b>Connect with others.</b> Support groups, social workers, and patient advocates can provide emotional support and resources."
];

/* ---------- Modal helpers ---------- */
function openModal(id){
  const el = document.getElementById(id);
  el.setAttribute("aria-hidden","false");
  const first = el.querySelector("button, [href], input, summary");
  if(first) first.focus();
  document.addEventListener("keydown", escClose);
}
function closeModal(id){
  const el = document.getElementById(id);
  el.setAttribute("aria-hidden","true");
  document.removeEventListener("keydown", escClose);
}
function escClose(e){ if(e.key === "Escape"){ document.querySelectorAll(".modal[aria-hidden='false']").forEach(m=>m.setAttribute("aria-hidden","true")); } }

document.querySelectorAll("[data-open]").forEach(btn=>btn.addEventListener("click",e=>{e.preventDefault();openModal(btn.getAttribute("data-open"));}));
document.querySelectorAll("[data-close]").forEach(btn=>btn.addEventListener("click",()=>closeModal(btn.getAttribute("data-close"))));
document.querySelectorAll(".modal-backdrop").forEach(bg=>bg.addEventListener("click",()=>closeModal(bg.getAttribute("data-close"))));
document.getElementById("startHereBtn").addEventListener("click",()=>openModal("startModal"));

/* ---------- Build sections ---------- */
const container = document.getElementById("accordion");
function buildSections(){
  container.innerHTML = "";
  Object.entries(TOPICS).forEach(([key, topic])=>{
    const details = document.createElement("details");
    details.className = "section";

    const summary = document.createElement("summary");
    summary.textContent = topic.title;

    const wrap = document.createElement("div");
    wrap.className = "section-content";

    const toolbar = document.createElement("div");
    toolbar.className = "section-toolbar";

    const selectBtn = document.createElement("button");
    selectBtn.className = "mini"; selectBtn.type = "button"; selectBtn.textContent = "Select all";

    const clearBtn = document.createElement("button");
    clearBtn.className = "mini"; clearBtn.type = "button"; clearBtn.textContent = "Clear all";

    const er = document.createElement("a");
    er.className = "eres-btn";
    er.href = ER_LINKS[key] || "#";
    er.target = "_blank";
    er.rel = "noopener";
    er.setAttribute("aria-label", `Open eResources to Read for ${topic.title}`);
    er.textContent = "eResources to Read";

    const list = document.createElement("ul");
    list.className = "q-list";

    topic.questions.forEach((q, i)=>{
      const id = `q-${key}-${i}`;
      const li = document.createElement("li");
      li.innerHTML = `<input type="checkbox" id="${id}" /><label for="${id}">${q}</label>`;
      list.appendChild(li);
    });

    selectBtn.addEventListener("click", ()=>{
      list.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=true);
      updateActionsEnabled(); refreshSlider();
    });
    clearBtn.addEventListener("click", ()=>{
      list.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false);
      updateActionsEnabled(); refreshSlider();
    });

    toolbar.appendChild(selectBtn);
    toolbar.appendChild(clearBtn);
    toolbar.appendChild(er);

    wrap.appendChild(toolbar);
    wrap.appendChild(list);

    details.appendChild(summary);
    details.appendChild(wrap);
    container.appendChild(details);

    details.addEventListener("toggle", refreshSlider);
  });
}
buildSections();

/* ---------- Vertical slider sync ---------- */
const vslider = document.getElementById("vslider");
const vwrap = document.getElementById("vsliderWrap");
function refreshSlider(){
  const need = container.scrollHeight > container.clientHeight + 4;
  vwrap.classList.toggle("visible", need);
  vwrap.setAttribute("aria-hidden", need ? "false" : "true");
  if(!need) return;
  const maxScroll = container.scrollHeight - container.clientHeight;
  vslider.value = Math.round((container.scrollTop / maxScroll) * 100) || 0;
}
vslider.addEventListener("input", ()=>{
  const maxScroll = container.scrollHeight - container.clientHeight;
  container.scrollTop = (vslider.value/100) * maxScroll;
});
container.addEventListener("scroll", ()=>{
  const maxScroll = container.scrollHeight - container.clientHeight;
  if(maxScroll > 0){
    vslider.value = Math.round((container.scrollTop / maxScroll) * 100);
  }
});
window.addEventListener("resize", refreshSlider);

/* ---------- Action buttons enabled state ---------- */
const downloadBtn = document.getElementById("downloadPdfBtn");
const printBtn = document.getElementById("printPdfBtn");
const emailBtn = document.getElementById("emailPdfBtn");

function anySelected(){ return !!document.querySelector(".q-list input[type='checkbox']:checked"); }
function updateActionsEnabled(){ [downloadBtn, printBtn, emailBtn].forEach(b=>b.disabled = !anySelected()); }
container.addEventListener("change", ()=>{ updateActionsEnabled(); refreshSlider(); });
updateActionsEnabled();

/* ---------- Collect selected ---------- */
function collectSelected(){
  return Array.from(document.querySelectorAll(".q-list input[type='checkbox']:checked"))
    .map(cb => cb.nextElementSibling.textContent.trim());
}

/* ---------- Build Styled PDF (matches your mock) ---------- */
async function buildStyledPdf(selected){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "letter" }); // 612 x 792
  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();
  const M = 28;

  // helpers
  function rrect(x,y,w,h,r,stroke=true,fill=false){
    doc.setLineJoin("round");
    doc.roundedRect(x,y,w,h,r,r, stroke ? "S" : "", fill ? "F" : "");
  }
  function chip(text, top){
    const chipH = 38, chipR = 14;
    doc.setDrawColor(31,95,134);
    doc.setFillColor(232,243,255);
    rrect(W/2 - 180, top, 360, chipH, chipR, true, true);
    doc.setFont("helvetica","bold"); doc.setTextColor(27,78,115); doc.setFontSize(16);
    doc.text(text, W/2, top + chipH/2 + 5, { align:"center", baseline:"middle" });
  }
  function panel(x, y, w, h){
    doc.setDrawColor(31,95,134);
    rrect(x,y,w,h,20,true,false);
  }
  function bullets(list, x, y, maxW, maxH){
    const lh = 17;
    doc.setFont("helvetica","normal"); doc.setFontSize(12); doc.setTextColor(15,23,42);
    let cy = y;
    for(const item of list){
      const lines = doc.splitTextToSize(item, maxW - 22);
      lines[0] = "‚Ä¢ " + lines[0];
      for(const line of lines){
        if(cy + lh > y + maxH) return cy; // stop if overflow; caller can continue on next page
        doc.text(line, x + 12, cy);
        cy += lh;
      }
      cy += 6;
    }
    return cy;
  }

  // PAGE 1
  // outer frame
  doc.setDrawColor(31,95,134);
  rrect(M, M, W - 2*M, H - 2*M, 32,true,false);

  // first chip + panel for selected questions
  chip("Questions that you chose", M + 6);
  const panel1Y = M + 56;
  const panel1H = 280; // enough space as in screenshot; we‚Äôll continue to next page if overflow
  panel(M + 14, panel1Y, W - 2*M - 28, panel1H);

  // second chip + panel for recommendations
  chip("Recommendations that other patients found helpful", panel1Y + panel1H + 22);
  const panel2Y = panel1Y + panel1H + 74;
  const panel2H = H - M - panel2Y - 14;
  panel(M + 14, panel2Y, W - 2*M - 28, panel2H);

  // Fill questions (panel 1)
  let cy = bullets(selected.length ? selected : ["(No questions selected)"], M + 14, panel1Y + 24, W - 2*M - 28, panel1H - 48);

  // Fill recommendations (panel 2) with bold lead phrase
  const recPlain = RECOMMENDATIONS.map(r => r.replace(/<\/?b>/g,""));
  // draw as bullets, but make first sentence/bold phrase bold
  let ry = panel2Y + 24, lh = 17;
  const maxW = W - 2*M - 28;
  for(const raw of recPlain){
    // Bold first sentence up to first period or emdash
    const m = raw.match(/^([^\.‚Äî‚Äì-]+)(.*)$/);
    const lead = m ? m[1].trim() : raw;
    const rest = m ? m[2].trim() : "";
    const bullet = "‚Ä¢ ";

    // lead
    doc.setFont("helvetica","bold"); doc.setFontSize(12);
    let leadLines = doc.splitTextToSize(lead, maxW - 22);
    leadLines[0] = bullet + leadLines[0];
    for(const line of leadLines){
      if(ry + lh > panel2Y + panel2H - 24) break;
      doc.text(line, M + 26, ry); ry += lh;
    }
    // rest
    if(rest){
      doc.setFont("helvetica","normal");
      const restLines = doc.splitTextToSize(" " + rest, maxW - 22);
      for(const line of restLines){
        if(ry + lh > panel2Y + panel2H - 24) break;
        doc.text(line, M + 26, ry); ry += lh;
      }
    }
    ry += 6;
  }

  // PAGE 2 (prompt list look) ‚Äî optional, only if many selected
  if(selected.length > 12){
    doc.addPage();
    const W2 = doc.internal.pageSize.getWidth(), H2 = doc.internal.pageSize.getHeight();
    doc.setDrawColor(31,95,134);
    rrect(M, M, W2 - 2*M, H2 - 2*M, 32,true,false);

    // Banner area like screenshot
    doc.setFillColor(218,231,242);
    rrect(M + 12, M + 18, W2 - 2*M - 24, 70, 28, true, true);
    doc.setFont("helvetica","bold"); doc.setTextColor(27,78,115); doc.setFontSize(14);
    doc.text("Please let us know what is on your mind now:", M + 28, M + 60);

    // Section block with many items
    doc.setFillColor(233,238,243);
    rrect(M + 22, M + 96, W2 - 2*M - 64, H2 - (M + 140), 12, true, true);
    const startY = M + 120, maxH2 = H2 - (M + 160);
    bullets(selected, M + 30, startY, W2 - 2*M - 80, maxH2);
  }

  return doc;
}

/* ---------- Utilities ---------- */
function docToBlobUrl(doc){
  const blob = doc.output("blob");
  return URL.createObjectURL(blob);
}

/* ---------- Download ---------- */
downloadBtn.addEventListener("click", async ()=>{
  const selected = collectSelected(); if(!selected.length) return;
  const doc = await buildStyledPdf(selected);
  doc.save("care-questions.pdf");
});

/* ---------- Print ---------- */
printBtn.addEventListener("click", async ()=>{
  const selected = collectSelected(); if(!selected.length) return;
  const doc = await buildStyledPdf(selected);
  const url = docToBlobUrl(doc);
  const w = window.open(url, "_blank");
  const tick = setInterval(()=>{
    if(!w) return;
    if(w.document && w.document.readyState === "complete"){
      clearInterval(tick); w.focus(); w.print();
    }
  }, 150);
  const cleanup = () => { URL.revokeObjectURL(url); w && w.removeEventListener("beforeunload", cleanup); };
  w && w.addEventListener("beforeunload", cleanup);
});

/* ---------- Email / Share ---------- */
emailBtn.addEventListener("click", async ()=>{
  const selected = collectSelected(); if(!selected.length) return;
  const doc = await buildStyledPdf(selected);
  const blob = doc.output("blob");
  const file = new File([blob], "care-questions.pdf", { type: "application/pdf" });

  if(navigator.canShare && navigator.canShare({ files: [file] })){
    try{
      await navigator.share({
        title: "Care Questions",
        text: "Here are the questions I'd like to discuss with my care team.",
        files: [file]
      });
      return;
    }catch(e){ if(e && e.name === "AbortError") return; }
  }

  const body = [
    "Hi,",
    "",
    "Please find my questions below. I will attach the PDF as well.",
    "",
    ...selected.map((q,i)=>`‚Ä¢ ${q}`),
    "",
    "Thank you."
  ].join("\n");
  const mailto = `mailto:?subject=${encodeURIComponent("Care Questions")}&body=${encodeURIComponent(body)}`;

  // auto-download so user can attach in their mail client
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "care-questions.pdf";
  document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 10000);
  window.location.href = mailto;
});

/* ---------- Dev-only: build Link Audit table (unchanged) ---------- */
(function buildAudit(){
  const rows = [];
  document.querySelectorAll('.grid .card').forEach(card=>{
    const img = card.querySelector('img');
    const thumb = card.querySelector('a.thumb');
    const title = card.querySelector('.card-title a');
    if(img && thumb && title){
      rows.push({
        label: title.textContent.trim(),
        img: img.getAttribute('src') || '',
        thumb: thumb.getAttribute('href') || '',
        title: title.getAttribute('href') || ''
      });
    }
  });

  const wrap = document.getElementById('auditTableWrap');
  if(!wrap) return;
  const table = document.createElement('table');
  table.innerHTML = `
    <thead>
      <tr><th>Card</th><th>Image src</th><th>Thumb link</th><th>Title link</th></tr>
    </thead>
    <tbody>
      ${rows.map(r=>`
        <tr>
          <td>${r.label}</td>
          <td><code>${r.img}</code></td>
          <td><a href="${r.thumb}" target="_blank" rel="noopener">${r.thumb}</a></td>
          <td><a href="${r.title}" target="_blank" rel="noopener">${r.title}</a></td>
        </tr>`).join('')}
    </tbody>`;
  wrap.appendChild(table);
})();
refreshSlider();
</script>
</body>
</html>
