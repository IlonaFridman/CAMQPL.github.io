<!-- File: questions-to-provider.html -->
<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Questions to Provider</title>
  <style>
    :root { --bg: #0b0c10; --panel:#121317; --ink:#e8eaed; --muted:#a1a1aa; --accent:#4f46e5; --line:#1f2937; --ok:#16a34a; --warn:#ef4444; --shadow: 0 10px 30px rgba(0,0,0,.35); }
    [data-theme="light"] { --bg:#f6f7fb; --panel:#ffffff; --ink:#0b0c10; --muted:#5b5b66; --accent:#4f46e5; --line:#e5e7eb; --shadow: 0 10px 25px rgba(0,0,0,.08); }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .container{max-width:1100px;margin:32px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:22px;margin:0}
    .actions{display:flex;gap:8px}
    button,.btn{appearance:none;border:1px solid var(--line);background:var(--panel);color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow);transition:.15s}
    button:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--accent);border-color:transparent;color:white}
    .btn-danger{background:var(--warn);border-color:transparent;color:white}
    .btn-ghost{background:transparent;border-color:var(--line)}
    .search{display:flex;gap:8px;align-items:center;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:8px 12px;min-width:260px}
    .search input{border:0;outline:0;background:transparent;color:var(--ink);width:100%}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:10px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 6px 0;font-size:16px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px dashed var(--line);padding:4px 8px;border-radius:999px}
    .chip button{border:0;background:transparent;padding:0 4px;cursor:pointer}
    dialog{border:0;border-radius:18px;padding:0;width:min(820px,92vw);box-shadow:var(--shadow);background:var(--panel);color:var(--ink)}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line)}
    .modal-body{padding:14px 16px}
    .modal-foot{display:flex;gap:8px;justify-content:flex-end;padding:14px 16px;border-top:1px solid var(--line)}
    .split{display:grid;grid-template-columns:260px 1fr;gap:12px}
    .list{border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .list .item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
    .list .item:last-child{border-bottom:0}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 8px 0}
    .tab{border:1px solid var(--line);background:transparent;padding:8px 12px;border-radius:12px;cursor:pointer}
    .tab.active{background:var(--accent);border-color:transparent;color:white}
    .q-item{display:flex;gap:10px;align-items:flex-start;padding:8px 0;border-bottom:1px dashed var(--line)}
    .q-item:last-child{border-bottom:0}
    .inline{display:flex;gap:8px;align-items:center}
    input[type="text"],input[type="email"],select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:transparent;color:var(--ink)}
    textarea{min-height:120px;resize:vertical}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;border:1px solid var(--line);padding:2px 6px;border-radius:6px}
    .empty{padding:18px;border:1px dashed var(--line);border-radius:12px;text-align:center;color:var(--muted)}
    .sr-only{position:absolute !important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    @media (max-width:800px){ .split{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container" id="app">
    <header>
      <div class="row">
        <h1>Questions to Provider</h1>
        <span class="chip" title="Tips">Press <span class="kbd">/</span> to search</span>
      </div>
      <div class="actions">
        <div class="search" role="search">
          <span aria-hidden="true">üîé</span>
          <input id="search" placeholder="Search providers..." autocomplete="off" />
        </div>
        <button id="addProviderBtn" class="btn-primary" aria-haspopup="dialog">Add Provider</button>
        <button id="themeBtn" class="btn-ghost" title="Toggle theme">Theme</button>
      </div>
    </header>

    <section id="providersSection">
      <div id="providersGrid" class="grid" aria-live="polite"></div>
      <div id="emptyProviders" class="empty" hidden>No providers yet. Click ‚ÄúAdd Provider‚Äù.</div>
    </section>
  </div>

  <!-- Composer Modal -->
  <dialog id="composer" aria-labelledby="composerTitle">
    <form method="dialog" id="composerForm">
      <div class="modal-head">
        <h2 id="composerTitle" style="margin:0;font-size:18px">Compose Questions</h2>
        <button class="btn-ghost" value="cancel" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body split">
        <div>
          <div class="list" aria-label="Providers">
            <div class="item">
              <label for="providerSelect" class="sr-only">Provider</label>
              <select id="providerSelect"></select>
            </div>
            <div class="item"><span class="muted">Email</span><span id="providerEmail" class="muted"></span></div>
            <div class="item"><span class="muted">Specialty</span><span id="providerSpec" class="muted"></span></div>
          </div>

          <div style="margin-top:12px">
            <div class="tabs" role="tablist" aria-label="Question categories" id="tabs"></div>
            <div id="questions" aria-live="polite"></div>
            <div style="margin-top:10px" class="inline">
              <input id="customInput" type="text" placeholder="Add custom question‚Ä¶ (Enter)" />
              <button type="button" id="addCustomBtn">Add</button>
            </div>
            <div id="customList" style="margin-top:8px"></div>
          </div>
        </div>

        <div>
          <label for="preview" class="muted">Preview</label>
          <textarea id="preview" readonly></textarea>
          <div class="inline" style="margin-top:8px">
            <button type="button" id="refreshBtn" title="Rebuild preview">Refresh</button>
            <button type="button" id="copyBtn">Copy</button>
            <button type="button" id="emailBtn" class="btn-primary">Send Email</button>
          </div>
          <p class="muted" style="margin-top:8px">Select questions, then Refresh ‚ûú Copy or Send Email.</p>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn-ghost" value="cancel">Close</button>
      </div>
    </form>
  </dialog>

  <!-- Provider Form Modal -->
  <dialog id="providerModal" aria-labelledby="providerTitle">
    <form id="providerForm" method="dialog">
      <div class="modal-head">
        <h2 id="providerTitle" style="margin:0;font-size:18px">Add Provider</h2>
        <button class="btn-ghost" value="cancel" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="providerId" />
        <div class="row" style="gap:12px">
          <label style="flex:1">
            <span class="muted">Name</span>
            <input id="providerName" required placeholder="Dr. Jane Smith" />
          </label>
          <label style="flex:1">
            <span class="muted">Specialty</span>
            <input id="providerSpecInput" placeholder="Primary Care" />
          </label>
        </div>
        <div class="row" style="gap:12px;margin-top:10px">
          <label style="flex:1">
            <span class="muted">Email</span>
            <input id="providerEmailInput" type="email" placeholder="name@example.com" />
          </label>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn-ghost" value="cancel">Cancel</button>
        <button id="saveProviderBtn" class="btn-primary" value="default">Save</button>
      </div>
    </form>
  </dialog>

  <script>
    // File: /public/questions-to-provider.html
    const LS_KEYS = {
      providers: 'qtp.providers.v1',
      custom: 'qtp.custom.v1',
      theme: 'qtp.theme.v1',
    };

    const DEFAULT_PROVIDERS = [
      { id: crypto.randomUUID(), name: 'Dr. Alex Smith', specialty: 'Primary Care', email: 'alex.smith@example.com' },
      { id: crypto.randomUUID(), name: 'Dr. Maya Lee', specialty: 'Cardiology', email: 'maya.lee@example.com' },
      { id: crypto.randomUUID(), name: 'Billing Office', specialty: 'Billing', email: 'billing@example.com' },
    ];

    const CATEGORIES = ['General','Medication','Test Results','Symptoms','Procedures','Billing'];
    const DEFAULT_QUESTIONS = {
      'General': [
        'What are the next steps in my care?',
        'What signs should prompt me to seek urgent help?',
        'When should I schedule my next appointment?'
      ],
      'Medication': [
        'What is this medication for and how does it work?',
        'What are common side effects and what should I do if I notice them?',
        'How long should I take this medication?'
      ],
      'Test Results': [
        'Can you explain my latest test results in plain language?',
        'Do I need any follow-up tests?',
        'How do these results change my treatment plan?'
      ],
      'Symptoms': [
        'Could these new symptoms be related to my condition or medication?',
        'What self-care steps can I take to manage these symptoms?',
        'At what point should I go to urgent care or ER?'
      ],
      'Procedures': [
        'What are the benefits and risks of this procedure?',
        'What does recovery look like and how long will it take?',
        'Are there alternatives I should consider?'
      ],
      'Billing': [
        'Can you provide an itemized bill for recent services?',
        'Is this procedure covered by my insurance and what will I owe?',
        'Who can I contact for financial assistance or payment plans?'
      ],
    };

    // State
    let providers = loadJSON(LS_KEYS.providers) ?? DEFAULT_PROVIDERS;
    let customQuestions = loadJSON(LS_KEYS.custom) ?? []; // array of strings
    let activeCategory = CATEGORIES[0];

    // DOM refs
    const grid = document.getElementById('providersGrid');
    const emptyProviders = document.getElementById('emptyProviders');
    const search = document.getElementById('search');
    const addProviderBtn = document.getElementById('addProviderBtn');
    const themeBtn = document.getElementById('themeBtn');

    // Modals
    const composer = document.getElementById('composer');
    const providerSelect = document.getElementById('providerSelect');
    const providerEmail = document.getElementById('providerEmail');
    const providerSpec = document.getElementById('providerSpec');
    const tabs = document.getElementById('tabs');
    const qContainer = document.getElementById('questions');
    const preview = document.getElementById('preview');
    const refreshBtn = document.getElementById('refreshBtn');
    const copyBtn = document.getElementById('copyBtn');
    const emailBtn = document.getElementById('emailBtn');
    const customInput = document.getElementById('customInput');
    const addCustomBtn = document.getElementById('addCustomBtn');
    const customList = document.getElementById('customList');

    const providerModal = document.getElementById('providerModal');
    const providerForm = document.getElementById('providerForm');
    const providerId = document.getElementById('providerId');
    const providerName = document.getElementById('providerName');
    const providerSpecInput = document.getElementById('providerSpecInput');
    const providerEmailInput = document.getElementById('providerEmailInput');
    const providerTitle = document.getElementById('providerTitle');

    // Init
    (function init(){
      // theme
      const theme = localStorage.getItem(LS_KEYS.theme) || 'light';
      document.documentElement.setAttribute('data-theme', theme);
      renderProviders();
      bindEvents();
      renderTabs();
      document.addEventListener('keydown', (e)=>{ if(e.key==='/'){e.preventDefault();search.focus()} });
    })();

    function bindEvents(){
      addProviderBtn.addEventListener('click', ()=>openProviderForm());
      themeBtn.addEventListener('click', toggleTheme);
      search.addEventListener('input', renderProviders);

      providerSelect.addEventListener('change', updateProviderInfo);
      refreshBtn.addEventListener('click', buildPreview);
      copyBtn.addEventListener('click', copyPreview);
      emailBtn.addEventListener('click', sendEmail);

      addCustomBtn.addEventListener('click', addCustom);
      customInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addCustom(); } });

      // Close modals on Escape
      [composer, providerModal].forEach(dlg=>{
        dlg.addEventListener('cancel', (e)=>{ /* avoid default ‚Äúclose‚Äù animation overlap */ });
      });

      providerForm.addEventListener('submit', onSaveProvider);
    }

    function toggleTheme(){
      const now = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', now);
      localStorage.setItem(LS_KEYS.theme, now);
    }

    // Providers UI
    function renderProviders(){
      const term = (search.value || '').toLowerCase().trim();
      const filtered = term ? providers.filter(p =>
        [p.name,p.specialty,p.email].join(' ').toLowerCase().includes(term)
      ) : providers.slice();

      grid.innerHTML = '';
      if(!filtered.length){ emptyProviders.hidden = false; return; }
      emptyProviders.hidden = true;

      for(const p of filtered){
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <h3>${escapeHtml(p.name)}</h3>
          <div class="muted">${escapeHtml(p.specialty || '‚Äî')}</div>
          <div class="muted">${escapeHtml(p.email || 'No email')}</div>
          <div class="row">
            <button class="btn-primary" data-ask="${p.id}" aria-haspopup="dialog">Questions to Provider</button>
            <button class="btn-ghost" data-edit="${p.id}">Edit</button>
            <button class="btn-danger" data-del="${p.id}">Delete</button>
          </div>
        `;
        el.querySelector('[data-ask]').addEventListener('click', ()=>openComposer(p.id));
        el.querySelector('[data-edit]').addEventListener('click', ()=>openProviderForm(p.id));
        el.querySelector('[data-del]').addEventListener('click', ()=>deleteProvider(p.id));
        grid.appendChild(el);
      }
    }

    function openProviderForm(id){
      if(id){
        const p = providers.find(x=>x.id===id);
        providerTitle.textContent = 'Edit Provider';
        providerId.value = p.id;
        providerName.value = p.name;
        providerSpecInput.value = p.specialty || '';
        providerEmailInput.value = p.email || '';
      }else{
        providerTitle.textContent = 'Add Provider';
        providerId.value = '';
        providerForm.reset();
        providerSpecInput.value = '';
      }
      providerModal.showModal();
      setTimeout(()=>providerName.focus(), 50);
      trapFocus(providerModal);
    }

    function onSaveProvider(e){
      e.preventDefault();
      const id = providerId.value || crypto.randomUUID();
      const name = providerName.value.trim();
      const email = providerEmailInput.value.trim();
      const specialty = providerSpecInput.value.trim();
      if(!name){ alert('Name is required.'); return; }
      if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ alert('Invalid email.'); return; }

      const idx = providers.findIndex(p=>p.id===id);
      const record = { id, name, specialty, email };
      if(idx>=0){ providers[idx] = record; } else { providers.push(record); }
      saveJSON(LS_KEYS.providers, providers);
      providerModal.close();
      renderProviders();
    }

    function deleteProvider(id){
      const p = providers.find(x=>x.id===id);
      if(!p) return;
      if(!confirm(`Delete ${p.name}?`)) return;
      providers = providers.filter(x=>x.id!==id);
      saveJSON(LS_KEYS.providers, providers);
      renderProviders();
    }

    // Composer
    function openComposer(providerId){
      providerSelect.innerHTML = providers.map(p=>`<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
      if(providerId){ providerSelect.value = providerId; }
      updateProviderInfo();
      renderTabs();
      renderQuestions(activeCategory);
      renderCustomQuestions();
      buildPreview();
      composer.showModal();
      setTimeout(()=>providerSelect.focus(), 50);
      trapFocus(composer);
    }

    function updateProviderInfo(){
      const p = providers.find(x=>x.id===providerSelect.value);
      providerEmail.textContent = p?.email || '‚Äî';
      providerSpec.textContent = p?.specialty || '‚Äî';
    }

    function renderTabs(){
      tabs.innerHTML = '';
      for(const cat of CATEGORIES){
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'tab' + (cat===activeCategory?' active':'');
        b.setAttribute('role','tab');
        b.setAttribute('aria-selected', cat===activeCategory?'true':'false');
        b.textContent = cat;
        b.addEventListener('click', ()=>{
          activeCategory = cat;
          [...tabs.children].forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          renderQuestions(cat);
        });
        tabs.appendChild(b);
      }
    }

    function renderQuestions(category){
      const items = DEFAULT_QUESTIONS[category] || [];
      qContainer.innerHTML = '';
      if(!items.length){ qContainer.innerHTML = `<div class="empty">No templates.</div>`; return; }
      for(const q of items){
        const id = 'q_' + hash(q);
        const row = document.createElement('div');
        row.className = 'q-item';
        row.innerHTML = `
          <input id="${id}" type="checkbox" />
          <label for="${id}" style="flex:1">${escapeHtml(q)}</label>
        `;
        qContainer.appendChild(row);
      }
    }

    function renderCustomQuestions(){
      customList.innerHTML = '';
      if(!customQuestions.length){
        customList.innerHTML = `<div class="empty">No custom questions yet.</div>`;
        return;
      }
      const wrap = document.createElement('div');
      wrap.className = 'inline';
      wrap.style.flexWrap = 'wrap';
      for(const q of customQuestions){
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `${escapeHtml(q)} <button title="Remove">&times;</button>`;
        chip.querySelector('button').addEventListener('click', ()=>{
          customQuestions = customQuestions.filter(x=>x!==q);
          saveJSON(LS_KEYS.custom, customQuestions);
          renderCustomQuestions();
          buildPreview();
        });
        wrap.appendChild(chip);
      }
      customList.appendChild(wrap);
    }

    function addCustom(){
      const val = (customInput.value || '').trim();
      if(!val) return;
      if(customQuestions.includes(val)){ alert('Already added.'); return; }
      customQuestions.push(val);
      saveJSON(LS_KEYS.custom, customQuestions);
      customInput.value = '';
      renderCustomQuestions();
      buildPreview();
    }

    function collectSelected(){
      const selected = [];
      qContainer.querySelectorAll('input[type="checkbox"]').forEach((cb,i)=>{
        if(cb.checked){
          const label = cb.nextElementSibling?.textContent || '';
          selected.push(label);
        }
      });
      // custom are always included in preview; user can remove chips to exclude
      selected.push(...customQuestions);
      // de-dup to avoid repeats
      return [...new Set(selected.map(s=>s.trim()).filter(Boolean))];
    }

    function buildPreview(){
      const p = providers.find(x=>x.id===providerSelect.value);
      const qs = collectSelected();
      const lines = [];
      if(p){ lines.push(`To: ${p.name}${p.email? ' <'+p.email+'>':''}`); }
      lines.push(`Subject: Questions regarding my care`);
      lines.push('');
      if(!qs.length){ lines.push('‚Ä¢ (No questions selected)'); }
      else { qs.forEach((q,i)=>lines.push(`${i+1}. ${q}`)); }
      lines.push('');
      lines.push('Thank you,');
      lines.push('[Your Name]');
      preview.value = lines.join('\n');
    }

    function sendEmail(){
      const p = providers.find(x=>x.id===providerSelect.value);
      if(!p || !p.email){ alert('Selected provider has no email.'); return; }
      const qs = collectSelected();
      if(!qs.length){ if(!confirm('No questions selected. Send anyway?')) return; }
      const subject = encodeURIComponent('Questions regarding my care');
      const body = encodeURIComponent(qs.map((q,i)=>`${i+1}. ${q}`).join('\n') + '\n\nThank you,\n[Your Name]');
      const href = `mailto:${encodeURIComponent(p.email)}?subject=${subject}&body=${body}`;
      // Using window.open avoids some clients blocking navigation
      window.location.href = href;
    }

    async function copyPreview(){
      try{
        await navigator.clipboard.writeText(preview.value);
        toast('Copied preview to clipboard.');
      }catch{
        // Some browsers block clipboard without user gesture
        preview.select();
        document.execCommand?.('copy');
        toast('Preview selected; press Ctrl/Cmd+C to copy.');
      }
    }

    // Utils
    function loadJSON(key){ try{ return JSON.parse(localStorage.getItem(key)); }catch{return null} }
    function saveJSON(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
    function escapeHtml(s){ return (s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function hash(s){ let h=9; for(let i=0;i<s.length;i++) h = Math.imul(h ^ s.charCodeAt(i), 9**9); return (h^h>>>9)>>>0; }
    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      t.style.cssText = 'position:fixed;inset:auto 0 16px 0;margin:auto;background:var(--panel);color:var(--ink);border:1px solid var(--line);padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);width:fit-content';
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 2000);
    }

    // Focus trap to keep keyboard inside open dialog (for a11y)
    function trapFocus(dialog){
      const FOCUSABLE = 'button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])';
      const nodes = dialog.querySelectorAll(FOCUSABLE);
      if(!nodes.length) return;
      const first = nodes[0], last = nodes[nodes.length-1];
      function handle(e){
        if(e.key!=='Tab') return;
        // Keep focus inside when dialog is open
        if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
        else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
      }
      dialog.addEventListener('keydown', handle);
      const cleanup = ()=> dialog.removeEventListener('keydown', handle);
      dialog.addEventListener('close', cleanup, { once:true });
    }
  </script>
</body>
</html>
